<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Hub (The SAT Hub Theme)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="antialiased">

    <header class="sathub-header p-4 shadow-md">
        <div class="container mx-auto flex flex-wrap items-center justify-between">
            <div class="flex items-center">
                <img src="assets/logo.png" alt="The SAT Hub Logo" class="h-12 md:h-16 w-auto mr-2 md:mr-3 rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/128x128/ffffff/2a5266?text=LOGO';">
                <h1 class="sathub-header-title text-xl md:text-2xl font-bold">Analytics Hub</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="studentNameDisplay" class="text-sm hidden sm:block">Welcome! Student Name</span>
                <button id="refreshDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm">
                    Refresh Data
                </button>
                <button id="hamburgerButton" class="md:hidden text-f0f0f0 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto hidden md:flex">
            <button data-main-tab="overview" class="main-tab-button active py-3 px-4">Overview</button>
            <button data-main-tab="cb-practice-tests" class="main-tab-button py-3 px-4">CB Non-Adaptive Tests</button>
            <button data-main-tab="reading" class="main-tab-button py-3 px-4">Reading</button>
            <button data-main-tab="writing" class="main-tab-button py-3 px-4">Writing & Language</button>
            <button data-main-tab="math" class="main-tab-button py-3 px-4">Math</button>
        </div>
        <div id="mobileMenu" class="hidden md:hidden absolute top-full left-0 right-0 bg-white shadow-xl z-40">
            <a href="#" data-main-tab="overview" class="mobile-nav-link block py-3 px-4 text-gray-700 hover:bg-gray-100">Overview</a>
            <a href="#" data-main-tab="cb-practice-tests" class="mobile-nav-link block py-3 px-4 text-gray-700 hover:bg-gray-100">CB Non-Adaptive Tests</a>
            <a href="#" data-main-tab="reading" class="mobile-nav-link block py-3 px-4 text-gray-700 hover:bg-gray-100">Reading</a>
            <a href="#" data-main-tab="writing" class="mobile-nav-link block py-3 px-4 text-gray-700 hover:bg-gray-100">Writing & Language</a>
            <a href="#" data-main-tab="math" class="mobile-nav-link block py-3 px-4 text-gray-700 hover:bg-gray-100">Math</a>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6">
        <div id="overview-content" class="main-tab-content space-y-6">
            <section class="themed-card">
                <div class="themed-card-title-strip">Performance Snapshot</div>
                <div class="themed-card-body">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6" id="overview-kpis"></div>
                </div>
            </section>
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                <div class="themed-card chart-container">
                    <div class="themed-card-title-strip">Score Trend (CB Non-Adaptive Tests)</div>
                    <div class="themed-card-body"><canvas id="scoreTrendChart" height="250"></canvas></div>
                </div>
                <div class="themed-card chart-container">
                    <div class="themed-card-title-strip">Overall Skill Performance</div>
                    <div class="themed-card-body"><canvas id="overallSkillChart" height="250"></canvas></div>
                </div>
            </section>
            <section class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <div class="themed-card"><div class="themed-card-title-strip">Top 3 Strengths</div><div class="themed-card-body" id="overviewStrengthsContainer"></div></div>
                <div class="themed-card"><div class="themed-card-title-strip">Top 3 Areas for Improvement</div><div class="themed-card-body" id="overviewImprovementsContainer"></div></div>
                <div class="themed-card"><div class="themed-card-title-strip">Time Spent (Portal Usage)</div><div class="themed-card-body" id="timeSpentOverview"></div></div>
            </section>
        </div>

        <div id="cb-practice-tests-content" class="main-tab-content hidden"><section class="themed-card"><div class="themed-card-title-strip">CB Non-Adaptive Tests</div><div class="themed-card-body overflow-x-auto"><table class="min-w-full table"><thead><tr><th>Test Name</th><th>Date Attempted</th><th>R&W Score</th><th>Math Score</th><th>Total Score</th></tr></thead><tbody id="cb-practice-tests-table-body"></tbody></table></div></section></div>
        
        <div id="reading-content" class="main-tab-content hidden space-y-6">
            <div class="flex flex-wrap space-x-2 mb-4 border-b pb-2">
                <button data-sub-tab="reading-skills-hub" class="sub-tab-button active">Skills Hub</button>
                <button data-sub-tab="reading-eoc" class="sub-tab-button">EOC Practice</button>
                <button data-sub-tab="reading-khan" class="sub-tab-button">Khan Academy Practice</button>
            </div>
            <div id="reading-skills-hub-content" class="sub-tab-content-panel"><section class="themed-card"><div class="themed-card-title-strip">Reading Skills Hub</div><div class="themed-card-body space-y-3" id="reading-skills-hub-body"></div></section></div>
            <div id="reading-eoc-content" class="sub-tab-content-panel hidden"><section class="themed-card"><div class="themed-card-title-strip">Reading EOC Practice</div><div class="themed-card-body overflow-x-auto"><table class="min-w-full table"><thead id="reading-eoc-thead"></thead><tbody id="reading-eoc-tbody"></tbody></table></div></section></div>
            <div id="reading-khan-content" class="sub-tab-content-panel hidden"><section class="themed-card"><div class="themed-card-title-strip">Khan Academy Practice - Reading</div><div class="themed-card-body" id="reading-khan-data"></div></section></div>
        </div>

        <div id="writing-content" class="main-tab-content hidden space-y-6">
            <div class="flex flex-wrap space-x-2 mb-4 border-b pb-2">
                <button data-sub-tab="writing-skills-hub" class="sub-tab-button active">Skills Hub</button>
                <button data-sub-tab="writing-eoc" class="sub-tab-button">EOC Practice</button>
                <button data-sub-tab="writing-khan" class="sub-tab-button">Khan Academy Practice</button>
            </div>
            <div id="writing-skills-hub-content" class="sub-tab-content-panel"><section class="themed-card"><div class="themed-card-title-strip">Writing & Language Skills Hub</div><div class="themed-card-body space-y-3" id="writing-skills-hub-body"></div></section></div>
            <div id="writing-eoc-content" class="sub-tab-content-panel hidden"><section class="themed-card"><div class="themed-card-title-strip">Writing & Language EOC Practice</div><div class="themed-card-body overflow-x-auto"><table class="min-w-full table"><thead id="writing-eoc-thead"></thead><tbody id="writing-eoc-tbody"></tbody></table></div></section></div>
            <div id="writing-khan-content" class="sub-tab-content-panel hidden"><section class="themed-card"><div class="themed-card-title-strip">Khan Academy Practice - Writing & Language</div><div class="themed-card-body" id="writing-khan-data"></div></section></div>
        </div>

        <div id="math-content" class="main-tab-content hidden space-y-6">
            <div class="flex flex-wrap space-x-2 mb-4 border-b pb-2">
                <button data-sub-tab="math-skills-hub" class="sub-tab-button active">Skills Hub</button>
                <button data-sub-tab="math-eoc" class="sub-tab-button">EOC Practice</button>
                <button data-sub-tab="math-khan" class="sub-tab-button">Khan Academy Practice</button>
            </div>
            <div id="math-skills-hub-content" class="sub-tab-content-panel"><section class="themed-card"><div class="themed-card-title-strip">Math Skills Hub</div><div class="themed-card-body space-y-3" id="math-skills-hub-body"></div></section></div>
            <div id="math-eoc-content" class="sub-tab-content-panel hidden"><section class="themed-card"><div class="themed-card-title-strip">Math EOC Practice</div><div class="themed-card-body overflow-x-auto"><table class="min-w-full table"><thead id="math-eoc-thead"></thead><tbody id="math-eoc-tbody"></tbody></table></div></section></div>
            <div id="math-khan-content" class="sub-tab-content-panel hidden"><section class="themed-card"><div class="themed-card-title-strip">Khan Academy Practice - Math</div><div class="themed-card-body" id="math-khan-data"></div></section></div>
        </div>
    </main>

    <footer class="bg-gray-100 border-t border-gray-200 mt-8">
        <div class="container mx-auto py-4 px-6 text-center text-gray-600 text-sm">
            &copy; <span id="currentYear"></span> The SAT Hub. All Rights Reserved.
        </div>
    </footer>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="text-xl font-semibold">Detailed View</h2>
                <span class="close-button" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" class="modal-body-content">
                </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        // --- CONSTANTS FOR DATA FILE URLs ---
        const AGGREGATED_SCORES_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSySYBO9YL3N4aUG3JEYZMQQIv9d1oSm3ba4Ty9Gt4SsGs2zmTS_k81rH3Qv41mZvClnayNcDpl_QbI/pub?gid=1890969747&single=true&output=csv'; // Phase 1
        const QUESTION_DETAILS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJl8XYak_fAzpuboA6GgOO-hEMd6rP_X9BD7ruZ-pSnIGKkd27uGmP2ZWeBcwSvSKsafObcXDOW080/pub?gid=822014112&single=true&output=csv'; // Phase 2
        const STUDENT_MAPPING_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJl8XYak_fAzpuboA6GgOO-hEMd6rP_X9BD7ruZ-pSnIGKkd27uGmP2ZWeBcwSvSKsafObcXDOW080/pub?gid=0&single=true&output=csv'; // Phase 2

        // --- CONFIGURATION ---
        // IMPORTANT: The dashboard will now prompt for the student's email.
        // For initial testing or if you want to hardcode, uncomment and set this:
        // let STUDENT_EMAIL_TO_FILTER = "student@example.com"; 

        // --- GLOBAL DATA STORAGE ---
        let currentStudentData = {};
        let ALL_DASHBOARD_QUESTIONS = [];


        // --- MAPPING SAT SKILLS TO BOOK CHAPTERS (extracted from your PDF) ---
        const SAT_CHAPTER_SKILL_MAPPING = {
            math: {
                "Understanding and applying properties of exponents": ["1: Exponents & Radicals"],
                "working with radical expressions": ["1: Exponents & Radicals"],
                "understanding rational exponents": ["1: Exponents & Radicals"],
                "Calculating and applying percentages": ["2: Percent"],
                "percent increase/decrease": ["2: Percent"],
                "solving word problems involving percents": ["2: Percent"],
                "Identifying, interpreting, and comparing linear and exponential growth models": ["3: Exponential & Linear Growth"],
                "creating and solving equations from these models": ["3: Exponential & Linear Growth"],
                "Calculating and applying rates, including unit rates, speed, and work rates": ["4: Rates"],
                "unit conversions": ["4: Rates"],
                "Setting up and solving problems involving ratios and proportions": ["5: Ratio & Proportion"],
                "Manipulating and simplifying algebraic expressions, including polynomials": ["6: Expressions"],
                "factoring": ["6: Expressions"],
                "Translating word problems into algebraic equations or inequalities": ["7: Constructing Models"],
                "creating linear and nonlinear models": ["7: Constructing Models"],
                "Solving linear equations in one or more variables": ["8: Manipulating & Solving Equations"],
                "solving various forms of nonlinear equations": ["8: Manipulating & Solving Equations"],
                "Applying advanced strategies to solve complex equations, including those involving quadratics, absolute values, and systems": ["9: More Equation Solving Strategies"],
                "Solving systems of two linear equations in two variables using various methods (substitution, elimination)": ["10: Systems of Equations"],
                "Solving linear inequalities in one or two variables": ["11: Inequalities"],
                "graphing solutions": ["11: Inequalities"],
                "Applying algebraic and arithmetic skills to solve a variety of contextualized problems": ["12: Word Problems"],
                "Solving optimization problems, often by finding the vertex of a quadratic function or analyzing inequalities": ["13: Min & Max Word Problems"],
                "Understanding and applying properties of lines, including slope, intercepts, and equations of lines": ["14: Lines"],
                "Interpreting the slope and intercepts of linear models in context": ["15: Interpreting Linear Models"],
                "making predictions (linear models)": ["15: Interpreting Linear Models"],
                "Understanding function notation, domain, range": ["16: Functions"],
                "evaluating functions": ["16: Functions"],
                "transformations (functions)": ["16: Functions"],
                "composition of functions": ["16: Functions"],
                "Solving quadratic equations (factoring, quadratic formula, completing the square)": ["17: Quadratics"],
                "graphing parabolas": ["17: Quadratics"],
                "understanding properties of quadratic functions": ["17: Quadratics"],
                "Performing polynomial division (specifically synthetic division)": ["18: Synthetic Division"],
                "finding roots of polynomials": ["18: Synthetic Division"],
                "Performing operations with complex numbers": ["19: Complex Numbers"],
                "Solving equations and inequalities involving absolute value": ["20: Absolute Value"],
                "Understanding and applying angle relationships": ["21: Angles"],
                "Applying properties of triangles, including Pythagorean theorem, similar triangles, special right triangles, and basic trigonometric ratios": ["22: Triangles"],
                "Understanding and applying properties of circles, including equations, radius, diameter, circumference, area, arc length, and sector area": ["23: Circles"],
                "Applying trigonometric ratios (sine, cosine, tangent) in right triangles": ["24: Trigonometry"],
                "understanding radians and the unit circle (basics)": ["24: Trigonometry"],
                "Interpreting and analyzing data presented in tables, charts, and graphs (scatterplots, bar graphs, line graphs)": ["25: Reading Data"],
                "Calculating basic probabilities, including compound events": ["26: Probability"],
                "Calculating and interpreting measures of central tendency (mean, median, mode) and spread (range)": ["27: Statistics 1"],
                "Understanding standard deviation, distributions (like normal distribution basics), and basic statistical inference": ["28: Statistics 2"],
                "Calculating the volume of 3D shapes (e.g., prisms, cylinders, cones, spheres)": ["29: Volume"]
            },
            writing: {
                "Choosing the most logical and effective transition words or phrases to connect ideas, sentences, and paragraphs": ["1: Transitions"],
                "Ensuring writing is concise, precise, and directly relevant to the rhetorical situation or main idea": ["2: Specific Focus"],
                "eliminating redundancy": ["2: Specific Focus"],
                "Identifying and correcting sentence fragments and run-on sentences": ["3: Sentences & Fragments"],
                "ensuring complete sentence structures": ["3: Sentences & Fragments"],
                "Correctly using punctuation (commas, semicolons, colons) and conjunctions to join or separate independent and dependent clauses": ["4: Joining & Separating Sentences"],
                "Advanced application of rules for combining clauses and phrases, avoiding fragments and run-ons": ["5: Joining Sentences & Fragments"],
                "Correctly punctuating restrictive (essential) and non-restrictive (non-essential) clauses, primarily with commas": ["6: Non-Essential & Essential Clauses"],
                "Applying comma rules for items in a series, introductory elements, appositives, interrupters, and avoiding common misuses like comma splices": ["7: Additional Comma Uses & Misuses"],
                "Ensuring subject-verb agreement and consistent, appropriate verb tense": ["8: Verbs Agreements and Tense"],
                "Ensuring pronoun-antecedent agreement, correct pronoun case (subjective, objective, possessive), and clear pronoun reference": ["9: Pronouns"],
                "Correctly using apostrophes for possessive nouns, possessive pronouns (or lack thereof), and contractions": ["10: Apostrophes"],
                "Ensuring modifiers (adjectives, adverbs, phrases, clauses) are correctly placed to modify the intended word and avoiding dangling or misplaced modifiers": ["11: Modification"],
                "Maintaining parallel grammatical structure for items in a list, series, or comparison": ["12: Parallel Structure"],
                "Choosing the correct word from commonly confused pairs (e.g., affect/effect)": ["13: Word Pairs"],
                "understanding idiomatic expressions": ["13: Word Pairs"],
                "Correctly using question marks at the end of direct questions": ["14: Question Marks"],
                "Understanding the function of different parts of speech as a foundation for other grammar rules": ["Appendix: Parts of Speech"]
            },
            reading: {
                "Understanding the overall structure and approach to the Reading and Writing section": ["1: Overview of SAT Reading"],
                "Determining the meaning of words and phrases as they are used in particular contexts within the passage": ["2: Vocabulary in Context"],
                "Drawing logical inferences and conclusions based on information stated or implied in the text": ["3: Making the Leap"],
                "Identifying the main idea or central theme of a passage or a significant portion of it": ["4: The Big Picture"],
                "Locating and understanding explicitly stated information and details within the text": ["5: Literal Comprehension"],
                "Analyzing how specific words, phrases, sentences, or paragraphs contribute to the author's overall purpose, argument, or the structure of the text": ["6: Reading for Function"],
                "Choosing words/phrases that best complete the meaning/logic of a portion of text": ["7: Text Completions"],
                "Identifying textual evidence that best supports a given claim or identifying claims/evidence that would undermine an argument": ["8: Supporting & Undermining"],
                "Interpreting data presented in tables, graphs, and charts, and integrating that information with textual information": ["9: Graphs & Charts"],
                "Analyzing the relationship between two related texts, including identifying points of agreement/disagreement, or how one text responds to/elabo rates on the other": ["10: Paired Passages"],
                "Reviewing various question formats and strategies for approaching them": ["Appendix: Question Types"]
            }
        };

        const STATIC_CHAPTER_LISTS = {
            math: [
                "1: Exponents & Radicals", "2: Percent", "3: Exponential & Linear Growth",
                "4: Rates", "5: Ratio & Proportion", "6: Expressions", "7: Constructing Models",
                "8: Manipulating & Solving Equations", "9: More Equation Solving Strategies",
                "10: Systems of Equations", "11: Inequalities", "12: Word Problems",
                "13: Min & Max Word Problems", "14: Lines", "15: Interpreting Linear Models",
                "16: Functions", "17: Quadratics", "18: Synthetic Division", "19: Complex Numbers",
                "20: Absolute Value", "21: Angles", "22: Triangles", "23: Circles", "24: Trigonometry",
                "25: Reading Data", "26: Probability", "27: Statistics 1", "28: Statistics 2", "29: Volume"
            ],
            writing: [
                "1: Transitions", "2: Specific Focus", "3: Sentences & Fragments",
                "4: Joining & Separating Sentences", "5: Joining Sentences & Fragments",
                "6: Non-Essential & Essential Clauses", "7: Additional Comma Uses & Misuses",
                "8: Verbs Agreements and Tense", "9: Pronouns", "10: Apostrophes",
                "11: Modification", "12: Parallel Structure", "13: Word Pairs", "14: Question Marks",
                "Appendix: Parts of Speech"
            ],
            reading: [
                "1: Overview of SAT Reading", "2: Vocabulary in Context", "3: Making the Leap",
                "4: The Big Picture", "5: Literal Comprehension", "6: Reading for Function",
                "7: Text Completions", "8: Supporting & Undermining", "9: Graphs & Charts",
                "10: Paired Passages", "Appendix: Question Types"
            ]
        };

        function formatDate(dateString) {
            if (!dateString || dateString === "N/A" || dateString === "Not Attempted") return dateString;
            try {
                const date = new Date(dateString + 'T00:00:00');
                const day = date.getDate();
                const month = date.toLocaleString('default', { month: 'short' });
                const year = date.getFullYear();
                return `${day} ${month}, ${year}`;
            } catch (e) {
                console.warn("Error formatting date:", dateString, e);
                return dateString;
            }
        }

        function fetchCsv(url) {
            return new Promise((resolve, reject) => {
                PapaParse.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length) {
                            console.error('PapaParse errors for', url, ':', results.errors);
                            reject(results.errors);
                        } else {
                            resolve(results.data);
                        }
                    },
                    error: function(err) {
                        console.error('Network or parsing error for', url, ':', err);
                        reject(err);
                    }
                });
            });
        }

        async function loadAndProcessData(studentEmailToFilter) {
            console.log("Starting data loading and processing for:", studentEmailToFilter);

            try {
                const [aggregatedScoresRaw, questionDetailsRaw, studentMappingRaw] = await Promise.all([
                    fetchCsv(AGGREGATED_SCORES_CSV_URL),
                    fetchCsv(QUESTION_DETAILS_CSV_URL),
                    fetchCsv(STUDENT_MAPPING_CSV_URL)
                ]);
                console.log("Raw aggregated scores:", aggregatedScoresRaw.length, "rows.");
                console.log("Raw question details:", questionDetailsRaw.length, "rows.");
                console.log("Raw student mapping:", studentMappingRaw.length, "rows.");

                const studentInfo = studentMappingRaw.find(s => s['Student Email'] === studentEmailToFilter);
                if (!studentInfo) {
                    console.error(`Student with email ${studentEmailToFilter} not found in student mapping.`);
                    document.getElementById('overview-kpis').innerHTML = '<p class="text-red-600 text-center col-span-5">Error: Student data not found. Please check the provided email.</p>';
                    return;
                }
                const studentIDFromMapping = studentInfo['Student ID'];

                const studentAggregatedScores = aggregatedScoresRaw.filter(row => row['Student ID'] === studentIDFromMapping);
                const studentQuestionDetails = questionDetailsRaw.filter(row => row['Student ID'] === studentIDFromMapping);
                console.log(`Filtered data for student ${studentIDFromMapping} (Email: ${studentEmailToFilter}):`);
                console.log("Aggregated scores rows:", studentAggregatedScores.length);
                console.log("Question details rows:", studentQuestionDetails.length);

                currentStudentData = {
                    name: studentInfo['Student Name'] || `Student ${studentIDFromMapping}`,
                    targetScore: parseInt(studentInfo['Target SAT Score']) || 1400,
                    latestScores: { total: 0, rw: 0, math: 0, avgEocKhan: 0 },
                    timeSpent: { studentAvg: 0, studentUnit: "min / day", classAvg: 0, classUnit: "min / day"},
                    scoreTrend: { labels: [], studentScores: [], classAvgScores: [] },
                    overallSkillPerformance: { labels: ['Reading', 'Writing', 'Math'], studentAccuracy: [0, 0, 0], classAvgAccuracy: [0, 0, 0] },
                    cbPracticeTests: [],
                    eocQuizzes: { reading: [], writing: [], math: [] },
                    khanAcademy: { reading: [], writing: [], math: [] },
                    skills: { reading: [], writing: [], math: [] },
                    chapters: STATIC_CHAPTER_LISTS
                };

                const latestTest = studentAggregatedScores
                    .filter(row => row['Assessment Type'] === 'CB Practice Test' && row['Total Score'] && row['Date Attempted'])
                    .sort((a, b) => new Date(b['Date Attempted']) - new Date(a['Date Attempted']))[0];

                if (latestTest) {
                    currentStudentData.latestScores.total = parseInt(latestTest['Total Score']) || 0;
                    currentStudentData.latestScores.rw = parseInt(latestTest['R&W Score']) || 0;
                    currentStudentData.latestScores.math = parseInt(latestTest['Math Score']) || 0;
                    const avgEocKhanRow = studentAggregatedScores.find(row => row['Assessment Type'] === 'Overall Average');
                    if (avgEocKhanRow && avgEocKhanRow['Avg EOC/Khan Score']) {
                         currentStudentData.latestScores.avgEocKhan = parseFloat(avgEocKhanRow['Avg EOC/Khan Score']) || 0;
                    } else {
                        currentStudentData.latestScores.avgEocKhan = 0;
                    }
                }

                const scoreTrendData = studentAggregatedScores
                    .filter(row => row['Assessment Type'] === 'CB Practice Test' && row['Total Score'] && row['Date Attempted'])
                    .sort((a, b) => new Date(a['Date Attempted']) - new Date(b['Date Attempted']));

                currentStudentData.scoreTrend.labels = scoreTrendData.map(row => row['Test Name']);
                currentStudentData.scoreTrend.studentScores = scoreTrendData.map(row => parseInt(row['Total Score']) || 0);
                currentStudentData.scoreTrend.classAvgScores = scoreTrendData.map(row => parseInt(row['Class Avg Total']) || 0);

                const timeSpentRow = studentAggregatedScores.find(row => row['Assessment Type'] === 'Time Spent');
                if (timeSpentRow) {
                    currentStudentData.timeSpent.studentAvg = parseFloat(timeSpentRow['Your Avg Time (min/day)']) || 0;
                    currentStudentData.timeSpent.classAvg = parseFloat(timeSpentRow['Class Avg Time (min/day)']) || 0;
                } else {
                    currentStudentData.timeSpent = { studentAvg: 0, studentUnit: "min / day", classAvg: 0, classUnit: "min / day"};
                }

                const cbTestsMap = new Map();
                const eocQuizzesMap = { reading: new Map(), writing: new Map(), math: new Map() };
                const skillsPerformance = { reading: {}, writing: {}, math: {} };

                studentQuestionDetails.forEach(qRow => {
                    if (!qRow['Question ID'] || !qRow['Subject'] || !qRow['SAT Skill']) {
                        console.warn("Skipping question row due to missing essential data:", qRow);
                        return;
                    }

                    const questionId = qRow['Question ID'];
                    const subject = (qRow['Subject'] || '').toLowerCase();
                    const skill = qRow['SAT Skill'];
                    const difficulty = qRow['Difficulty'] || 'Unknown';
                    const yourAnswer = qRow['Student Answer'] || '';
                    const correctAnswer = qRow['Correct Answer'] || '';
                    const isCorrect = (yourAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase() && yourAnswer !== '' && correctAnswer !== '');
                    const explanation = qRow['Explanation'] || 'No explanation available.';
                    const yourTime = parseFloat(qRow['Your Time (s)']) || 0;
                    const classAvgTime = parseFloat(qRow['Class Avg Time (s)']) || 0;
                    const source = qRow['Test Name'] || qRow['Quiz Name'] || 'Unknown Source';
                    const questionText = qRow['Question Text'] || `Question ${questionId}`;

                    const classCorrect = parseFloat(qRow['Class % Correct']) || 0;
                    const classIncorrect = parseFloat(qRow['Class % Incorrect']) || 0;
                    const classUnanswered = parseFloat(qRow['Class % Unanswered']) || (100 - classCorrect - classIncorrect);

                    const questionObj = {
                        id: questionId,
                        subject: subject,
                        skill: skill,
                        difficulty: difficulty,
                        yourAnswer: yourAnswer,
                        correctAnswer: correctAnswer,
                        isCorrect: isCorrect,
                        explanation: explanation,
                        yourTime: yourTime,
                        classAvgTime: classAvgTime,
                        classPerformance: {
                            correct: classCorrect,
                            incorrect: classIncorrect,
                            unanswered: classUnanswered
                        },
                        source: source,
                        text: questionText
                    };
                    ALL_DASHBOARD_QUESTIONS.push(questionObj);

                    if (qRow['Assessment Type'] === 'CB Practice Test' && source) {
                        if (!cbTestsMap.has(source)) {
                            const testAggregate = studentAggregatedScores.find(r => r['Test Name'] === source && r['Assessment Type'] === 'CB Practice Test');
                            cbTestsMap.set(source, {
                                name: source,
                                date: testAggregate ? (testAggregate['Date Attempted'] || "Not Attempted") : "Not Attempted",
                                rw: testAggregate ? (testAggregate['R&W Score'] || "-") : "-",
                                math: testAggregate ? (testAggregate['Math Score'] || "-") : "-",
                                total: testAggregate ? (testAggregate['Total Score'] || "-") : "-",
                                questions: []
                            });
                        }
                        cbTestsMap.get(source).questions.push(questionObj);
                    } else if (qRow['Assessment Type'] === 'EOC Quiz' && subject && eocQuizzesMap[subject] && source) {
                        if (!eocQuizzesMap[subject].has(source)) {
                            eocQuizzesMap[subject].set(source, {
                                name: source,
                                date: qRow['Date Attempted'] || "N/A",
                                latestScore: `${classCorrect}%`,
                                questions: []
                            });
                        }
                        eocQuizzesMap[subject].get(source).questions.push(questionObj);
                    }

                    if (skill && subject && ['reading', 'writing', 'math'].includes(subject)) {
                        if (!skillsPerformance[subject][skill]) {
                            skillsPerformance[subject][skill] = {
                                correctCount: 0,
                                totalCount: 0,
                                classCorrectSum: 0,
                                classTotalCount: 0
                            };
                        }
                        skillsPerformance[subject][skill].totalCount++;
                        if (isCorrect) {
                            skillsPerformance[subject][skill].correctCount++;
                        }
                        skillsPerformance[subject][skill].classCorrectSum += classCorrect;
                        skillsPerformance[subject][skill].classTotalCount++;
                    }
                });

                currentStudentData.cbPracticeTests = Array.from(cbTestsMap.values());
                const allCBTestNames = [
                    "Diagnostic Test", "Official Practice Test 1", "Official Practice Test 4",
                    "Official Practice Test 5", "Official Practice Test 6", "Official Practice Test 7",
                    "Official Practice Test 8", "Official Practice Test 9", "Official Practice Test 10"
                ];
                allCBTestNames.forEach(testName => {
                    if (!currentStudentData.cbPracticeTests.some(test => test.name === testName)) {
                        const testAggregate = studentAggregatedScores.find(r => r['Test Name'] === testName && r['Assessment Type'] === 'CB Practice Test');
                        currentStudentData.cbPracticeTests.push({
                            name: testName,
                            date: testAggregate ? (testAggregate['Date Attempted'] || "Not Attempted") : "Not Attempted",
                            rw: testAggregate ? (testAggregate['R&W Score'] || "-") : "-",
                            math: testAggregate ? (testAggregate['Math Score'] || "-") : "-",
                            total: testAggregate ? (testAggregate['Total Score'] || "-") : "-",
                            questions: []
                        });
                    }
                });
                currentStudentData.cbPracticeTests.sort((a, b) => {
                    const dateA = new Date(a.date !== "Not Attempted" ? a.date : "1970-01-01");
                    const dateB = new Date(b.date !== "Not Attempted" ? b.date : "1970-01-01");
                    return dateA - dateB;
                });


                ['reading', 'writing', 'math'].forEach(sub => {
                    currentStudentData.eocQuizzes[sub] = Array.from(eocQuizzesMap[sub].values());
                    currentStudentData.eocQuizzes[sub].sort((a, b) => new Date(a.date) - new Date(b.date));

                    for (const skillName in skillsPerformance[sub]) {
                        const skillData = skillsPerformance[sub][skillName];
                        const studentScore = skillData.totalCount > 0 ? Math.round((skillData.correctCount / skillData.totalCount) * 100) : 0;
                        const classAvg = skillData.classTotalCount > 0 ? Math.round((skillData.classCorrectSum / skillData.classTotalCount)) : 0;

                        currentStudentData.skills[sub].push({
                            name: skillName,
                            score: studentScore,
                            classAvg: classAvg,
                            attempted: skillData.totalCount > 0
                        });
                    }
                });

                ['reading', 'writing', 'math'].forEach((sub, index) => {
                    const subjectSkills = currentStudentData.skills[sub];
                    if (subjectSkills.length > 0) {
                        const totalStudentScore = subjectSkills.reduce((sum, s) => sum + s.score, 0);
                        const totalClassAvg = subjectSkills.reduce((sum, s) => sum + s.classAvg, 0);
                        currentStudentData.overallSkillPerformance.studentAccuracy[index] = Math.round(totalStudentScore / subjectSkills.length);
                        currentStudentData.overallSkillPerformance.classAvgAccuracy[index] = Math.round(totalClassAvg / subjectSkills.length);
                    } else {
                         currentStudentData.overallSkillPerformance.studentAccuracy[index] = 0;
                         currentStudentData.overallSkillPerformance.classAvgAccuracy[index] = 0;
                    }
                });


                console.log("Final processed currentStudentData:", currentStudentData);

                populateDashboardUI();

            } catch (error) {
                console.error("Failed to load or process data:", error);
                document.getElementById('overview-kpis').innerHTML = '<p class="text-red-600 text-center col-span-5">Error loading dashboard data. Please try again later or check console for details.</p>';
                document.getElementById('cb-practice-tests-table-body').innerHTML = '<tr><td colspan="5" class="text-red-600 text-center">Failed to load test data.</td></tr>';
            }
        }


        function populateDashboardUI() {
            document.getElementById('studentNameDisplay').textContent = `Welcome! ${currentStudentData.name}`;

            populateOverview(currentStudentData);
            populatePracticeTestsTable(currentStudentData.cbPracticeTests);

            ['reading', 'writing', 'math'].forEach(subject => {
                populateEOCPractice(subject, currentStudentData.eocQuizzes[subject] || []);
                populateKhanAcademy(subject, currentStudentData.khanAcademy[subject] || []);
            });

            document.querySelector('.main-tab-button[data-main-tab="overview"]')?.click();
        }


        window.onload = function() {
            // Chart.js Global Configuration
            Chart.defaults.font.family = 'Inter';
            Chart.defaults.plugins.legend.position = 'bottom';
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;

            // Prompt for email ID on initial load
            let studentEmail = localStorage.getItem('dashboardStudentEmail');
            if (!studentEmail) {
                studentEmail = prompt("Please enter your student email ID:");
                if (studentEmail) {
                    localStorage.setItem('dashboardStudentEmail', studentEmail);
                } else {
                    alert("No email provided. Dashboard might not load personalized data.");
                    studentEmail = "default@example.com"; // Provide a fallback if user cancels
                }
            }

            loadAndProcessData(studentEmail); // Pass the email to the loading function
            setupEventListeners();
        };


        function setupEventListeners() {
            const mainTabs = document.querySelectorAll('.main-tab-button');
            const mainTabContents = document.querySelectorAll('.main-tab-content');
            const hamburgerButton = document.getElementById('hamburgerButton');
            const mobileMenu = document.getElementById('mobileMenu');
            const refreshDataBtn = document.getElementById('refreshDataBtn');

            document.getElementById('currentYear').textContent = new Date().getFullYear();

            hamburgerButton?.addEventListener('click', () => mobileMenu?.classList.toggle('hidden'));
            refreshDataBtn?.addEventListener('click', handleRefreshData);

            const switchMainTab = (tabElement) => {
                const targetTabName = tabElement.getAttribute('data-main-tab');

                mainTabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.mobile-nav-link').forEach(link => link.classList.remove('active'));
                mainTabContents.forEach(content => content.classList.add('hidden'));

                document.querySelector(`.main-tab-button[data-main-tab="${targetTabName}"]`)?.classList.add('active');
                document.querySelector(`.mobile-nav-link[data-main-tab="${targetTabName}"]`)?.classList.add('active');
                document.getElementById(targetTabName + '-content')?.classList.remove('hidden');

                if (targetTabName === 'overview') {
                    initializeOverviewCharts(currentStudentData);
                } else if (['reading', 'writing', 'math'].includes(targetTabName)) {
                    const firstSubTabButton = document.querySelector(`#${targetTabName}-content .sub-tab-button[data-sub-tab="${targetTabName}-skills-hub"]`);
                    if (firstSubTabButton) {
                        switchSubTab(firstSubTabButton);
                    }
                }
                mobileMenu?.classList.add('hidden');
            };

            mainTabs.forEach(tab => tab.addEventListener('click', () => switchMainTab(tab)));
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchMainTab(link);
                });
            });

            const switchSubTab = (subTabElement) => {
                const parentMainContent = subTabElement.closest('.main-tab-content');
                const targetSubTabName = subTabElement.getAttribute('data-sub-tab');

                parentMainContent.querySelectorAll('.sub-tab-button').forEach(st => st.classList.remove('active'));
                parentMainContent.querySelectorAll('.sub-tab-content-panel').forEach(panel => panel.classList.add('hidden'));

                subTabElement.classList.add('active');
                document.getElementById(targetSubTabName + '-content')?.classList.remove('hidden');

                if (targetSubTabName.endsWith('-skills-hub')) {
                    const subject = targetSubTabName.replace('-skills-hub', '');
                    populateSkillsHub(subject, currentStudentData.skills[subject] || []);
                }
            };

            document.querySelectorAll('.sub-tab-button').forEach(subTab => {
                subTab.addEventListener('click', () => switchSubTab(subTab));
            });
        }


        async function handleRefreshData() {
            console.log("Refresh Data button clicked! Reloading data from CSVs.");
            const originalRefreshText = document.getElementById('refreshDataBtn').textContent;
            document.getElementById('refreshDataBtn').textContent = 'Refreshing...';
            document.getElementById('refreshDataBtn').disabled = true;

            try {
                // For now, re-prompt for email to simulate full refresh from source
                let studentEmail = prompt("Please re-enter your student email ID to refresh data:");
                if (!studentEmail) {
                    alert("Refresh cancelled. No email provided.");
                    return; // Exit if no email
                }
                localStorage.setItem('dashboardStudentEmail', studentEmail); // Save for next time
                await loadAndProcessData(studentEmail); // Pass the new email
                alert("Dashboard data refreshed successfully!");
            } catch (error) {
                alert("Failed to refresh dashboard data. Check console for errors.");
            } finally {
                document.getElementById('refreshDataBtn').textContent = originalRefreshText;
                document.getElementById('refreshDataBtn').disabled = false;
            }
        }

        function populateOverview(data) {
            const kpiContainer = document.getElementById('overview-kpis');
            if (!kpiContainer) { console.error("Overview KPIs container not found."); return; }

            kpiContainer.innerHTML = `
                <div class="score-card"><h3 class="text-md font-medium text-gray-600">Latest Total Score</h3><p class="text-3xl font-bold score-value">${data.latestScores.total} <span class="text-lg text-gray-500">/ 1600</span></p></div>
                <div class="score-card"><h3 class="text-md font-medium text-gray-600">Latest R&W Score</h3><p class="text-3xl font-bold score-value">${data.latestScores.rw} <span class="text-lg text-gray-500">/ 800</span></p></div>
                <div class="score-card"><h3 class="text-md font-medium text-gray-600">Latest Math Score</h3><p class="text-3xl font-bold score-value">${data.latestScores.math} <span class="text-lg text-gray-500">/ 800</span></p></div>
                <div class="score-card"><h3 class="text-md font-medium text-gray-600">Avg EOC Score</h3><p class="text-3xl font-bold score-value">${data.latestScores.avgEocKhan}%</p></div>
                <div class="score-card"><h3 class="text-md font-medium text-gray-600">Your Target Score</h3><p class="text-3xl font-bold" style="color: #8a3ffc;">${data.targetScore}</p></div>`;

            const allSkills = Object.values(data.skills).flat().filter(s => s.attempted);
            const strengths = [...allSkills].sort((a, b) => b.score - a.score).slice(0, 3);
            const weaknesses = [...allSkills].sort((a, b) => a.score - b.score).slice(0, 3);

            const renderList = (items) => items.map(item => `<li>${item.name} (${item.score}%)</li>`).join('');
            document.getElementById('overviewStrengthsContainer').innerHTML = `<ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(strengths)}</ul>`;
            document.getElementById('overviewImprovementsContainer').innerHTML = `<ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(weaknesses)}</ul>`;

            document.getElementById('timeSpentOverview').innerHTML = `<p class="text-gray-600">Your Avg: <span class="font-semibold">${data.timeSpent.studentAvg} ${data.timeSpent.studentUnit}</span></p><p class="text-gray-600">Class Avg: <span class="font-semibold">${data.timeSpent.classAvg} ${data.timeSpent.classUnit}</span></p>`;
        }

        function initializeOverviewCharts(data) {
            ['scoreTrendChart', 'overallSkillChart'].forEach(id => {
                const instance = Chart.getChart(id);
                if (instance) instance.destroy();
            });

            new Chart('scoreTrendChart', {
                type: 'line',
                data: {
                    labels: data.scoreTrend.labels,
                    datasets: [{
                        label: 'Your Score',
                        data: data.scoreTrend.studentScores,
                        borderColor: '#2a5266',
                        tension: 0.1
                    }, {
                        label: 'Class Average',
                        data: data.scoreTrend.classAvgScores,
                        borderColor: '#757575',
                        borderDash: [5, 5],
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false,
                            suggestedMin: (Math.min(...data.scoreTrend.studentScores.filter(s => s > 0), ...data.scoreTrend.classAvgScores.filter(s => s > 0)) > 0 ? Math.min(...data.scoreTrend.studentScores.filter(s => s > 0), ...data.scoreTrend.classAvgScores.filter(s => s > 0)) : 1000) - 50,
                            suggestedMax: (Math.max(...data.scoreTrend.studentScores.filter(s => s > 0), ...data.scoreTrend.classAvgScores.filter(s => s > 0)) > 0 ? Math.max(...data.scoreTrend.studentScores.filter(s => s > 0), ...data.scoreTrend.classAvgScores.filter(s => s > 0)) : 1200) + 50,
                            title: {
                                display: true,
                                text: 'Total Score'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });

            new Chart('overallSkillChart', {
                type: 'bar',
                data: {
                    labels: data.overallSkillPerformance.labels,
                    datasets: [{
                        label: 'Your Accuracy',
                        data: data.overallSkillPerformance.studentAccuracy,
                        backgroundColor: 'rgba(42, 82, 102, 0.8)'
                    }, {
                        label: 'Class Average',
                        data: data.overallSkillPerformance.classAvgAccuracy,
                        backgroundColor: 'rgba(117, 117, 117, 0.7)'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Accuracy (%)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        function populateSkillsHub(subject, skills) {
            const container = document.getElementById(`${subject}-skills-hub-body`);
            if (!container) return;

            skills.sort((a, b) => a.score - b.score);

            if (skills.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">No skill data available for this subject.</p>';
                return;
            }

            container.innerHTML = skills.map(skill => {
                const performanceClass = skill.attempted ? (skill.score >= 85 ? 'performance-good' : skill.score >= 70 ? 'performance-average' : 'performance-poor') : 'performance-na';
                return `
                <div class="p-3 bg-gray-50 rounded-md border border-gray-200 mb-2 skill-item-container" onclick="openSkillIncorrectQuestionsModal('${skill.name}', '${subject}')">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-800">${skill.name}</span>
                        <span class="text-xs font-semibold">${skill.attempted ? skill.score + '%' : 'N/A'}</span>
                    </div>
                    <div class="progress-bar-container"><div class="progress-bar ${performanceClass}" style="width: ${skill.attempted ? skill.score : 0}%"></div></div>
                    <p class="text-xs text-gray-500 mt-1">Class Avg: ${skill.classAvg}%</p>
                </div>`;
            }).join('');
        }


        function populatePracticeTestsTable(tests) {
            const tableBody = document.getElementById('cb-practice-tests-table-body');
            if (!tableBody) return;

            if (tests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No CB Practice Test data available.</td></tr>';
                return;
            }

            tableBody.innerHTML = tests.map(test => {
                const isAttempted = test.date !== "Not Attempted" && test.date !== "-" && test.date !== null && test.date !== undefined;
                return `
                <tr class="${isAttempted ? 'clickable-row' : 'opacity-60'}" ${isAttempted ? `onclick="openTestQuestionsModal('${test.name}')"` : ''}>
                    <td>${test.name}</td>
                    <td>${formatDate(test.date)}</td>
                    <td>${test.rw}</td>
                    <td>${test.math}</td>
                    <td>${test.total}</td>
                </tr>`;
            }).join('');
        }

        function populateEOCPractice(subject, quizzes) {
            const tableBody = document.getElementById(`${subject}-eoc-tbody`);
            if (!tableBody) return;

            const eocThead = document.getElementById(`${subject}-eoc-thead`);
            if (eocThead) {
                const headers = ['Quiz Name', 'Date Attempted', 'Latest Score'];
                eocThead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            }

            if (quizzes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">No EOC practice data available.</td></tr>`;
                return;
            }

            tableBody.innerHTML = quizzes.map(quiz => `
                <tr class="clickable-row" onclick="openEOCQuizQuestionsModal('${quiz.name}', '${subject}')">
                    <td>${quiz.name}</td>
                    <td>${formatDate(quiz.date)}</td>
                    <td>${quiz.latestScore}</td>
                </tr>
            `).join('');
        }

        function populateKhanAcademy(subject, khanData) {
            const container = document.getElementById(`${subject}-khan-data`);
            if (!container) return;

            if (khanData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">No Khan Academy data available.</p>';
                return;
            }
            container.innerHTML = `<p class="text-gray-500 text-center p-4">Khan Academy data for ${subject} will be displayed here.</p>`;
        }

        const modal = document.getElementById('detailModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        function openSkillIncorrectQuestionsModal(skillName, subject) {
            modalTitle.textContent = `Incorrect Questions for: ${skillName} (${subject.charAt(0).toUpperCase() + subject.slice(1)})`;

            const incorrectQuestions = ALL_DASHBOARD_QUESTIONS.filter(q =>
                q.skill === skillName && !q.isCorrect && q.subject === subject
            );

            const difficultyOrder = { "Hard": 1, "Medium": 2, "Easy": 3 };
            incorrectQuestions.sort((a, b) => difficultyOrder[a.difficulty] - difficultyOrder[b.difficulty]);

            if (incorrectQuestions.length === 0) {
                modalBody.innerHTML = `<p class="text-center p-5 text-gray-600">No incorrect questions found for "${skillName}" in ${subject}. Great work!</p>`;
            } else {
                modalBody.innerHTML = incorrectQuestions.map((q, index) => renderQuestionAnalysisCard(q, `skill-${index}`, false)).join('');
            }
            modal.style.display = "block";
            renderDynamicCharts();
            addExplanationToggleListeners();
        }

        function openTestQuestionsModal(testName) {
            modalTitle.textContent = `Reviewing Test: ${testName}`;
            const test = currentStudentData.cbPracticeTests.find(t => t.name === testName);

            if (!test || !test.questions || test.questions.length === 0) {
                modalBody.innerHTML = `<p class="text-center p-5 text-gray-600">No question details found for ${testName}.</p>`;
                modal.style.display = "block";
                return;
            }

            let content = test.questions.map((q, index) => renderQuestionAnalysisCard(q, `test-${index}`, true)).join('');

            if (test.questions.some(q => q.yourTime !== undefined && q.classAvgTime !== undefined)) {
                content += `<h3 class="text-lg font-semibold text-gray-800 border-t pt-4 mt-6">Pacing Analysis</h3>`;
                content += `<div class="pacing-bar-chart-container"><canvas id="pacingBarChart"></canvas></div>`;

                const pacingRows = test.questions.map((p, index) => {
                    const diff = p.yourTime - p.classAvgTime;
                    const status = diff > (p.classAvgTime * 0.2) ? 'Slower' : diff < -(p.classAvgTime * 0.2) ? 'Faster' : 'On Pace';
                    const statusClass = `pacing-${status.toLowerCase().replace(' ', '-')}`;
                    return `<tr><td>${index + 1}</td><td>${p.yourTime}s</td><td>${p.classAvgTime}s</td><td><span class="pacing-badge ${statusClass}">${status}</span></td><td class="${p.isCorrect ? 'text-good' : 'text-poor'} font-semibold">${p.isCorrect ? 'Correct' : 'Incorrect'}</td></tr>`;
                }).join('');
                content += `<div class="overflow-x-auto mt-4"><table class="min-w-full table"><thead><tr><th>Q#</th><th>Your Time</th><th>Class Avg</th><th>Pacing</th><th>Result</th></tr></thead><tbody>${pacingRows}</tbody></table></div>`;
            }

            modalBody.innerHTML = content;
            modal.style.display = "block";
            renderDynamicCharts();
            addExplanationToggleListeners();
            if (test.questions.some(q => q.yourTime !== undefined)) {
                renderPacingBarChart('pacingBarChart', test.questions);
            }
        }

        function openEOCQuizQuestionsModal(quizName, subject) {
            modalTitle.textContent = `Reviewing EOC Quiz: ${quizName} (${subject.charAt(0).toUpperCase() + subject.slice(1)})`;
            const quizzesForSubject = currentStudentData.eocQuizzes[subject] || [];
            const quiz = quizzesForSubject.find(q => q.name === quizName);

            if (!quiz || !quiz.questions || quiz.questions.length === 0) {
                modalBody.innerHTML = `<p class="text-center p-5 text-gray-600">No questions found for ${quizName}.</p>`;
                modal.style.display = "block";
                return;
            }

            let content = quiz.questions.map((q, index) => renderQuestionAnalysisCard(q, `eoc-${index}`, false)).join('');

            modalBody.innerHTML = content;
            modal.style.display = "block";
            renderDynamicCharts();
            addExplanationToggleListeners();
        }


        function closeModal() {
            const canvases = modalBody.querySelectorAll('canvas');
            canvases.forEach(canvas => {
                const chart = Chart.getChart(canvas);
                if (chart) {
                    chart.destroy();
                }
            });

            modal.style.display = "none";
            modalBody.innerHTML = '';
        }
        window.onclick = (event) => {
            if (event.target == modal) {
                closeModal();
            }
        };

        function renderQuestionAnalysisCard(q, uniqueIdPrefix, includePacing = false) {
            const resultText = q.isCorrect ? "Correct" : "Incorrect";
            const resultClass = q.isCorrect ? "text-good" : "text-poor";
            const sourceInfo = q.source ? `<span class="meta-item text-gray-500">Source: ${q.source}</span>` : '';
            const questionTextDisplay = q.text ? `<p class="mb-2 text-gray-800 font-medium">${q.text}</p>` : `<p class="mb-2 text-gray-800 font-medium">Question ID: ${q.id}</p>`;

            const pacingHtml = includePacing && q.yourTime !== undefined ?
                `<p class="text-center text-sm mt-2">Pacing: <strong>${q.yourTime}s</strong> (Class Avg: ${q.classAvgTime}s)</p>` : '';

            const classCorrectPercentage = q.classPerformance ? q.classPerformance.correct : 'N/A';

            const explanationHtml = q.explanation ? `
                <button class="toggle-explanation-btn" data-target="explanation-${uniqueIdPrefix}-${q.id}">Show Explanation</button>
                <div id="explanation-${uniqueIdPrefix}-${q.id}" class="answer-explanation">
                    <p class="font-semibold text-sm">Explanation</p>
                    <p class="text-sm">${q.explanation}</p>
                </div>
            ` : '';

            const relevantChapters = getChaptersForSkill(q.skill, q.subject);
            const chapterReviewHtml = relevantChapters.length > 0 ? `
                <div class="mt-4 p-3 bg-blue-50 rounded-md border border-blue-200 text-sm">
                    <p class="font-semibold text-blue-800 mb-1">Review Chapters:</p>
                    <ul class="list-disc list-inside text-blue-700">
                        ${relevantChapters.map(chapter => `<li>${chapter}</li>`).join('')}
                    </ul>
                </div>
            ` : '';

            return `
            <div class="question-analysis-card">
                <div class="question-analysis-header">
                    <span class="font-semibold text-gray-700">${q.skill}</span>
                    <span class="difficulty-badge difficulty-${q.difficulty}">${q.difficulty}</span>
                    ${sourceInfo}
                </div>
                <div class="question-analysis-body">
                    <div>
                        ${questionTextDisplay}
                        <p>Your Answer: <span class="font-semibold ${resultClass}">${q.yourAnswer || 'N/A'}</span> <span class="font-bold">(${resultText})</span></p>
                        ${!q.isCorrect ? `<p>Correct Answer: <span class="font-semibold text-good">${q.correctAnswer || 'N/A'}</span></p>` : ''}
                        ${explanationHtml}
                        ${chapterReviewHtml}
                    </div>
                    <div>
                        <p class="text-center text-sm font-semibold mb-2">Class Performance: ${classCorrectPercentage}% Correct</p>
                        <div class="question-chart-container">
                            <canvas id="chart-${uniqueIdPrefix}-${q.id}"></canvas>
                        </div>
                        ${pacingHtml}
                    </div>
                </div>
            </div>`;
        }

        function getChaptersForSkill(skillName, subject) {
            const chapters = new Set();
            const skillMap = SAT_CHAPTER_SKILL_MAPPING[subject];

            if (skillMap) {
                for (const mappedSkill in skillMap) {
                    if (skillName && mappedSkill &&
                        (skillName.toLowerCase().includes(mappedSkill.toLowerCase()) ||
                         mappedSkill.toLowerCase().includes(skillName.toLowerCase()))) {
                        skillMap[mappedSkill].forEach(chapter => chapters.add(chapter));
                    }
                }
            }
            return Array.from(chapters).sort();
        }


        function renderDynamicCharts() {
            const canvases = modalBody.querySelectorAll('canvas[id^="chart-"]');
            canvases.forEach(canvas => {
                const chartId = canvas.id;
                const existingChart = Chart.getChart(chartId);
                if (existingChart) {
                    existingChart.destroy();
                }

                const parts = chartId.split('-');
                const qId = parts.slice(2).join('-');

                const qData = ALL_DASHBOARD_QUESTIONS.find(q => q.id === qId);

                if (qData && qData.classPerformance) {
                    const correct = qData.classPerformance.correct || 0;
                    const incorrect = qData.classPerformance.incorrect || 0;
                    const unanswered = qData.classPerformance.unanswered || 0;

                    new Chart(canvas, {
                        type: 'doughnut',
                        data: {
                            labels: ['Correct', 'Incorrect', 'Unanswered'],
                            datasets: [{
                                data: [correct, incorrect, unanswered],
                                backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                                borderColor: '#ffffff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        boxWidth: 12,
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += context.parsed + '%';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            cutout: '60%',
                        }
                    });
                }
            });
        }

        function renderPacingBarChart(canvasId, questions) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const existingChart = Chart.getChart(canvasId);
            if (existingChart) {
                existingChart.destroy();
            }

            const labels = questions.map((q, index) => `Q${index + 1}`);
            const yourTimes = questions.map(q => q.yourTime);
            const classAvgTimes = questions.map(q => q.classAvgTime);

            const backgroundColors = questions.map(q => {
                const diff = q.yourTime - q.classAvgTime;
                const avgTimeForCalc = q.classAvgTime > 0 ? q.classAvgTime : 1;
                if (diff > (avgTimeForCalc * 0.2)) return '#dc3545';
                if (diff < -(avgTimeForCalc * 0.2)) return '#28a745';
                return '#4b5563';
            });

            const borderColors = questions.map(q => {
                const diff = q.yourTime - q.classAvgTime;
                const avgTimeForCalc = q.classAvgTime > 0 ? q.classAvgTime : 1;
                if (diff > (avgTimeForCalc * 0.2)) return '#bb2124';
                if (diff < -(avgTimeForCalc * 0.2)) return '#198754';
                return '#2a5266';
            });

            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Your Time (s)',
                            data: yourTimes,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1,
                            barPercentage: 0.8,
                            categoryPercentage: 0.8
                        },
                        {
                            label: 'Class Avg Time (s)',
                            data: classAvgTimes,
                            backgroundColor: 'rgba(117, 117, 117, 0.5)',
                            borderColor: 'rgba(117, 117, 117, 0.8)',
                            borderWidth: 1,
                            type: 'line',
                            fill: false,
                            pointRadius: 3,
                            pointBackgroundColor: '#757575',
                            tension: 0.1,
                            hidden: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    if (context.dataset.label === 'Your Time (s)') {
                                        const qIndex = context.dataIndex;
                                        const question = questions[qIndex];
                                        const difficulty = question ? question.difficulty : 'N/A';
                                        return `${context.dataset.label}: ${context.parsed.y}s (Difficulty: ${difficulty})`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y}s`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Question Number'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }


        function addExplanationToggleListeners() {
            modalBody.querySelectorAll('.toggle-explanation-btn').forEach(button => {
                button.onclick = function() {
                    const targetId = this.getAttribute('data-target');
                    const explanationDiv = document.getElementById(targetId);
                    if (explanationDiv) {
                        explanationDiv.classList.toggle('expanded');
                        this.textContent = explanationDiv.classList.contains('expanded') ? 'Hide Explanation' : 'Show Explanation';
                    }
                };
            });
        }
    </script>
</body>
</html>
